<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fruit Counter</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{
    --bg-1:#0f1720;
    --bg-2:#071022;
    --card:#0f1724;
    --accent:#00d084;
    --muted:#9aa6b2;
    --glass: rgba(255,255,255,0.04);
  }
  *{box-sizing:border-box}
  body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(135deg,var(--bg-1),var(--bg-2)); color: #e6f0f2; margin: 0; -webkit-font-smoothing:antialiased; }
  header { display: flex; align-items: center; justify-content: space-between; padding: 20px; backdrop-filter: blur(6px); background: linear-gradient(90deg, rgba(255,255,255,0.03), transparent); border-bottom: 1px solid rgba(255,255,255,0.03); }
  h2 { margin: 0; font-weight:700; letter-spacing:1px; }
  .controls { display:flex; align-items:center; gap:12px; position:relative; }
  button { background: var(--accent); color: #042024; border: none; padding: 10px 14px; cursor: pointer; border-radius: 10px; font-weight:600; box-shadow: 0 6px 20px rgba(0,0,0,0.45); transition: transform .12s ease, box-shadow .12s ease; }
  button:hover{ transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.6); }
  button.secondary{ background: transparent; color: #e6f0f2; border: 1px solid rgba(255,255,255,0.06); padding:8px 12px; border-radius:8px; box-shadow:none; }
  button:disabled { background: #56616a; cursor: not-allowed; transform:none; box-shadow:none; }
  .qty-badge { display:inline-block; min-width:26px; text-align:center; padding:4px 8px; border-radius:14px; background: rgba(0,0,0,0.45); color:#fff; margin-left:8px; font-size:13px; font-weight:700; }
  .container { padding: 28px; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 22px; max-width:1200px; margin: 0 auto; }
  .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015)); padding: 12px; border-radius: 14px; text-align: left; overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.03); transition: transform .18s ease, box-shadow .18s ease; }
  .card:hover{ transform: translateY(-8px); box-shadow: 0 22px 60px rgba(2,8,23,0.7); }
  .card img{ width:100%; height:140px; object-fit:cover; border-radius:10px; display:block; }
  .card-body{ padding:10px 6px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .meta{ flex:1; }
  .name{ font-size:16px; font-weight:700; margin:0 0 6px 0; color:#e8fbf0; }
  .price{ font-size:14px; color:var(--accent); font-weight:800; margin-bottom:6px; }
  .stock-pill{ display:inline-block; padding:6px 8px; font-size:12px; border-radius:999px; background:var(--glass); color:var(--muted); border:1px solid rgba(255,255,255,0.03); }
  .card-footer{ display:flex; gap:8px; align-items:center; margin-top:8px; justify-content:space-between; }
  .add-btn{ background: linear-gradient(90deg,#00d084,#00b38a); color:#00241b; padding:8px 12px; border-radius:10px; font-weight:700; border:none; cursor:pointer; }
  .add-btn:active{ transform:scale(.98); }
  .ghost{ background:transparent; border:1px dashed rgba(255,255,255,0.04); color:#cfeee1; padding:6px 10px; border-radius:8px; }
  /* Modal Styling */
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 50; }
  .modal-content { background: linear-gradient(180deg,#071722, #05111a); margin: 6% auto; padding: 20px; width: 420px; border-radius: 12px; text-align: center; position: relative; max-height:80vh; overflow:auto; border:1px solid rgba(255,255,255,0.03); }
  .close { position: absolute; right: 12px; top: 8px; cursor: pointer; color: #fff; font-size: 22px; }
  input { width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid rgba(255,255,255,0.04); background: rgba(0,0,0,0.35); color: #e6f0f2; }
  .cart-item { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.02); }
  .small-btn { padding:6px 8px; font-size:13px; border-radius:8px; background:#0b1a1a; color:var(--accent); border:1px solid rgba(0,0,0,0.2); cursor:pointer; }
  @media (max-width:520px){
    .modal-content{ width:92%; margin-top:20% }
    header{ padding:12px }
    .container{ padding:16px; gap:14px }
  }
</style>
</head>
<body>
<header>
  <h2>Fruit Counter</h2>
  <div class="controls">
    <button id="cartBtn" class="secondary">Cart <span id="cartCount" class="qty-badge">0</span></button>
  </div>
</header>

<div class="container" id="fruitContainer"></div>

<!-- Cart Modal -->
<div id="cartModal" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="cartTitle">
    <span class="close" id="closeCart">&times;</span>
    <h3 id="cartTitle">Your Cart</h3>
    <div id="cartItems"></div>
    <div style="margin-top:12px; text-align:right;">
      <strong>Total: ₹<span id="cartTotal">0.00</span></strong>
    </div>
  </div>
</div>

<script>
/* robust image fallback + lazy loading to avoid broken images showing up */
function imageError(img){
  try{
    img.onerror = null;
    img.src = 'https://via.placeholder.com/800x600.png?text=Image+Unavailable';
    img.loading = 'lazy';
    img.decoding = 'async';
    img.style.objectFit = 'cover';
  }catch(e){}
}

const API_BASE = 'http://localhost:4000/api';

// DEFAULT_FRUITS using Unsplash images
const DEFAULT_FRUITS = [
  { id: 1, name: 'Cavendish Banana', price: 45, stock: 8, image: 'https://media.istockphoto.com/id/925190686/photo/banana-bunch-on-the-wooden-table.jpg?s=1024x1024&w=is&k=20&c=TYNbZMXsUHNWu90jRHv72PcBkaZ8CZjQEtbe8MqkyKo=' },
  { id: 2, name: 'Royal Gala Apple', price: 99, stock: 8, image: 'https://images.unsplash.com/photo-1689650552915-d547c24fe85e?q=80&w=1740&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
  { id: 3, name: 'Valencia Orange', price: 89, stock: 7, image: 'https://plus.unsplash.com/premium_photo-1671119151604-d2af993980ad?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTN8fFZhbGVuY2lhJTIwT3JhbmdlfGVufDB8fDB8fHww' },
  { id: 4, name: 'Green Grapes', price: 129, stock: 5, image: 'https://plus.unsplash.com/premium_photo-1692809723059-a70874355d1a?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MXx8R3JlZW4lMjBHcmFwZXN8ZW58MHx8MHx8fDA%3D' },
  { id: 5, name: 'Alphonso', price: 149, stock: 3, image: 'https://plus.unsplash.com/premium_photo-1724255863045-2ad716767715?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8OXx8YWxwaG9uc28lMjBtYW5nb3xlbnwwfHwwfHx8MA%3D%3D' },
  { id: 6, name: 'Strawberries', price: 199, stock: 0, image: 'https://plus.unsplash.com/premium_photo-1675731118661-15dc54c11130?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MXx8c3RyYXdiZXJyeXxlbnwwfHwwfHx8MA%3D%3D' },
  { id: 7, name: 'Kesar Mango', price: 159, stock: 6, image: 'https://images.unsplash.com/photo-1673010960635-d0d1ad81b90a?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8S0VTQVIlMjBNQU5HT3xlbnwwfHwwfHx8MA%3D%3D' },
  { id: 8, name: 'Pineapple', price: 119, stock: 4, image: 'https://plus.unsplash.com/premium_photo-1724255994628-dceb76a829e8?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MXx8cGluZWFwcGxlfGVufDB8fDB8fHww' },
  { id: 9, name: 'Kiwifruit', price: 79, stock: 10, image: 'https://source.unsplash.com/800x600/?kiwi' },
  { id: 10, name: 'Pomegranate', price: 139, stock: 5, image: 'https://source.unsplash.com/800x600/?pomegranate' },
  { id: 11, name: 'Blueberries', price: 249, stock: 2, image: 'https://source.unsplash.com/800x600/?blueberries' },
  { id: 12, name: 'Pear', price: 89, stock: 7, image: 'https://source.unsplash.com/800x600/?pear' },
  { id: 13, name: 'Dragon Fruit', price: 199, stock: 3, image: 'https://source.unsplash.com/800x600/?dragonfruit' },
  { id: 14, name: 'Papaya', price: 99, stock: 6, image: 'https://source.unsplash.com/800x600/?papaya' },
  { id: 15, name: 'Lemon', price: 29, stock: 20, image: 'https://source.unsplash.com/800x600/?lemon' },
  { id: 16, name: 'Lime', price: 25, stock: 18, image: 'https://source.unsplash.com/800x600/?lime' },
  { id: 17, name: 'Blackberries', price: 279, stock: 1, image: 'https://source.unsplash.com/800x600/?blackberries' },
  { id: 18, name: 'Raspberry', price: 169, stock: 5, image: 'https://source.unsplash.com/800x600/?raspberry' },
  { id: 19, name: 'Coconut', price: 129, stock: 9, image: 'https://source.unsplash.com/800x600/?coconut' },
  { id: 20, name: 'Apricot', price: 119, stock: 6, image: 'https://source.unsplash.com/800x600/?apricot' },
  { id: 21, name: 'Guava', price: 69, stock: 12, image: 'https://source.unsplash.com/800x600/?guava' },
  { id: 22, name: 'Fig', price: 189, stock: 4, image: 'https://source.unsplash.com/800x600/?fig' }
];

let cart = JSON.parse(localStorage.getItem('cart') || '[]');
let currentFruits = DEFAULT_FRUITS.slice();

const cartBtn = document.getElementById('cartBtn');
const cartModal = document.getElementById('cartModal');
const closeCart = document.getElementById('closeCart');
const cartItemsEl = document.getElementById('cartItems');
const cartCountEl = document.getElementById('cartCount');
const cartTotalEl = document.getElementById('cartTotal');

function saveCart(){ localStorage.setItem('cart', JSON.stringify(cart)); updateCartBadge(); }
function updateCartBadge(){ const totalQty = cart.reduce((s,i)=>s+i.qty,0); cartCountEl.textContent = totalQty; }
function calculateTotal(){ return cart.reduce((s,i)=>s + (i.price * i.qty), 0); }

function renderCart(){
  cartItemsEl.innerHTML = '';
  if (cart.length === 0) { cartItemsEl.innerHTML = '<p style="color:#bbb">Cart is empty</p>'; cartTotalEl.textContent = '0.00'; return; }
  cart.forEach(item => {
    const div = document.createElement('div');
    div.className = 'cart-item';
    div.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center;">
        <img src="${escapeHtml((currentFruits.find(f=>f.id===item.id)||{}).image||'https://via.placeholder.com/120x88.png?text=No+Image')}"
             alt="${escapeHtml(item.name)}" style="width:56px;height:44px;object-fit:cover;border-radius:6px;"
             onerror="imageError(this)" loading="lazy" decoding="async">
        <div>
          <div style="font-weight:700">${escapeHtml(item.name)}</div>
          <div style="color:#9fb3ab; font-size:13px;">₹${Number(item.price).toFixed(2)} x ${item.qty}</div>
        </div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="small-btn" data-action="dec" data-id="${item.id}">-</button>
        <button class="small-btn" data-action="inc" data-id="${item.id}">+</button>
        <button class="small-btn" data-action="remove" data-id="${item.id}">Remove</button>
      </div>
    `;
    cartItemsEl.appendChild(div);
  });
  cartTotalEl.textContent = calculateTotal().toFixed(2);
}

function renderFruitsList(fruits){
  const container = document.getElementById('fruitContainer');
  container.innerHTML = '';
  fruits.forEach(fruit => {
    container.innerHTML += `
      <div class="card" id="fruit-${fruit.id}">
        <img src="${escapeHtml(fruit.image || 'https://via.placeholder.com/600x400.png?text=No+Image')}" alt="${escapeHtml(fruit.name)}"
             onerror="imageError(this)" loading="lazy" decoding="async">
        <div class="card-body">
          <div class="meta">
            <div class="name">${escapeHtml(fruit.name)}</div>
            <div class="price">₹${Number(fruit.price).toFixed(2)}</div>
            <div class="stock-pill">Stock: <strong style="margin-left:6px;color:#cfeee1">${fruit.stock}</strong></div>
          </div>
          <div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px;">
            <button class="add-btn" onclick="addToCart(${fruit.id})" ${fruit.stock === 0 ? 'disabled' : ''}>Add</button>
            <button class="ghost" onclick="viewDetails(${fruit.id})">Details</button>
          </div>
        </div>
      </div>
    `;
  });
}

function viewDetails(id){
  const fruit = currentFruits.find(f=>f.id===id);
  if(!fruit) return;
  alert(fruit.name + '\n\nPrice: ₹' + Number(fruit.price).toFixed(2) + '\nStock: ' + fruit.stock);
}

async function loadFruits(){
  renderFruitsList(currentFruits);
  try{
    const res = await fetch(API_BASE + '/fruits');
    if(!res.ok) throw new Error('Failed to fetch');
    const fruits = await res.json();
    if(Array.isArray(fruits) && fruits.length){
      currentFruits = fruits.map(f => ({ image: `https://source.unsplash.com/800x600/?${encodeURIComponent(f.name)}`, ...f }));
      renderFruitsList(currentFruits);
    }
    updateCartBadge();
  }catch(err){
    console.warn('Using defaults',err);
    updateCartBadge();
  }
}

async function addToCart(id){
  try{
    const fruit = currentFruits.find(f=>f.id===id);
    if(!fruit || fruit.stock<=0){ alert('Out of stock'); return; }
    try{
      const res = await fetch(`${API_BASE}/cart/add/${id}`, { method:'POST' });
      if(res.ok){
        const data = await res.json();
        if(data && data.fruit && typeof data.fruit.stock === 'number'){
          const cf = currentFruits.find(x=>x.id===id);
          if(cf) cf.stock = data.fruit.stock;
        } else {
          const cf = currentFruits.find(x=>x.id===id);
          if(cf) cf.stock = Math.max(0, cf.stock - 1);
        }
      } else {
        const err = await res.json().catch(()=>({error:'Request failed'}));
        alert(err.error || err.message || 'Failed to add to cart');
        return;
      }
    }catch(e){
      const cf = currentFruits.find(x=>x.id===id);
      if(cf) cf.stock = Math.max(0, cf.stock - 1);
    }

    const stockEl = document.querySelector(`#fruit-${id} .stock-pill strong`);
    if(stockEl){
      let newStock = Number(stockEl.textContent) - 1;
      stockEl.textContent = newStock;
      if(newStock <= 0){
        const btn = document.querySelector(`#fruit-${id} .add-btn`);
        if(btn) btn.disabled = true;
      }
    }

    const existing = cart.find(c => c.id === id);
    if (existing) {
      existing.qty += 1;
    } else {
      cart.push({ id: fruit.id, name: fruit.name, price: fruit.price, qty: 1 });
    }
    saveCart();
    renderCart();
  }catch(err){
    console.error(err);
    alert('Failed to add to cart');
  }
}

cartBtn.onclick = () => { renderCart(); cartModal.style.display = 'block'; };
closeCart.onclick = () => cartModal.style.display = 'none';
window.onclick = (e) => {
  if (e.target === cartModal) cartModal.style.display = 'none';
};
cartItemsEl.addEventListener('click', (e) => {
  const btn = e.target.closest('button');
  if (!btn) return;
  const action = btn.getAttribute('data-action');
  const id = Number(btn.getAttribute('data-id'));
  const idx = cart.findIndex(i => i.id === id);
  if (idx === -1) return;
  if (action === 'inc') {
    const fruit = currentFruits.find(f => f.id === id);
    if (fruit && fruit.stock > 0) {
      fetch(`${API_BASE}/cart/add/${id}`, { method: 'POST' }).catch(()=>{});
      cart[idx].qty += 1;
      const stockEl = document.querySelector(`#fruit-${id} .stock-pill strong`);
      if (stockEl) {
        let newStock = Number(stockEl.textContent) - 1;
        stockEl.textContent = newStock;
        if (newStock <= 0) {
          const btnAdd = document.querySelector(`#fruit-${id} .add-btn`);
          if (btnAdd) btnAdd.disabled = true;
        }
      }
    } else {
      alert('No more stock available');
    }
  } else if (action === 'dec') {
    cart[idx].qty -= 1;
    const stockEl = document.querySelector(`#fruit-${id} .stock-pill strong`);
    if (stockEl) {
      let newStock = Number(stockEl.textContent) + 1;
      stockEl.textContent = newStock;
      const btnAdd = document.querySelector(`#fruit-${id} .add-btn`);
      if (btnAdd) btnAdd.disabled = false;
    }
    if (cart[idx].qty <= 0) cart.splice(idx,1);
  } else if (action === 'remove') {
    const qty = cart[idx].qty;
    const stockEl = document.querySelector(`#fruit-${id} .stock-pill strong`);
    if (stockEl) {
      let newStock = Number(stockEl.textContent) + qty;
      stockEl.textContent = newStock;
      const btnAdd = document.querySelector(`#fruit-${id} .add-btn`);
      if (btnAdd) btnAdd.disabled = newStock <= 0;
    }
    cart.splice(idx,1);
  }
  saveCart();
  renderCart();
});

function escapeHtml(str){ if(!str) return ''; return String(str).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

loadFruits();
renderCart();
window.addToCart = addToCart;
</script>
</body>
</html>
